<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OishiiT Display</title>
    <link rel="icon" href="/static/icons/favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            color: #fff;
            padding: 0 1vw;
        }

        #timer-container {
            font-size: 33vw;
            line-height: 1;
            font-weight: 900;
            text-align: center;
            font-feature-settings: "tnum" 1;
            font-variant-numeric: tabular-nums;
            transition: color 0.3s ease-in-out, font-size 0.3s ease-in-out;
        }

        /* Color States */
        .color-GREEN { color: #10b981; }
        .color-AMBER { color: #f59e0b; }
        .color-RED   { color: #ef4444; }
        .color-STOPPED { color: #ffffff; }

        .mode-clock-main {
            font-size: 15vw !important;
            line-height: 1.2;
        }

        .ampm-suffix { font-size: 0.25em; vertical-align: top; font-weight: 700; }
    </style>
</head>
<body class="bg-black">

    <div id="timer-container" class="color-STOPPED">
        --:--:--
    </div>

    <script>
        const API_STATE_ENDPOINT = '/api/state';
        const timerContainer = document.getElementById('timer-container');
        let lastColor = 'STOPPED';

        function formatTime(ms) {
            const isNegative = ms < 0;
            const totalSeconds = Math.floor(Math.abs(ms) / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            let timeString = '';
            if (hours > 0) timeString += `${hours.toString().padStart(2, '0')}:`;
            timeString += `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            return `<span class="time-digits">${isNegative ? 'â€“' : ''}${timeString}</span>`;
        }

        function formatTimeOfDay12Hr(time24Hr) {
            if (!time24Hr) return '';
            const parts = time24Hr.split(':');
            let hour = parseInt(parts[0]);
            const minute = parts[1];
            const second = parts[2];
            const ampm = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12 || 12;
            return `${hour.toString().padStart(2, '0')}:${minute}:${second}<span class="ampm-suffix">${ampm}</span>`;
        }

        async function updateDisplay() {
            try {
                const response = await fetch(API_STATE_ENDPOINT);
                const state = await response.json();

                const isRunning = state.is_running;
                const isFrozen = state.is_frozen;

                if (isRunning || isFrozen) {
                    // SHOW TIMER (Running or Frozen)
                    timerContainer.classList.remove('mode-clock-main');
                    timerContainer.classList.add('running');

                    // Note: If frozen, state.remaining_ms and state.color are static values sent by backend
                    timerContainer.innerHTML = formatTime(state.remaining_ms);

                    const newColor = state.color;
                    if (newColor !== lastColor) {
                        timerContainer.classList.remove(`color-${lastColor}`);
                        timerContainer.classList.add(`color-${newColor}`);
                        lastColor = newColor;
                    }

                } else {
                    // SHOW CLOCK
                    timerContainer.classList.add('mode-clock-main');
                    timerContainer.classList.remove('running');

                    timerContainer.innerHTML = formatTimeOfDay12Hr(state.server_time_of_day);

                    timerContainer.classList.remove(`color-${lastColor}`);
                    timerContainer.classList.add('color-STOPPED');
                    lastColor = 'STOPPED';
                }

            } catch (error) {
                console.error("Connection error:", error);
            }
        }

        setInterval(updateDisplay, 500);
        updateDisplay();
    </script>
</body>
</html>